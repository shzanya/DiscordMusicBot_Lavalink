
import discord
from discord import ui

from config.constants import Emojis
from ui.embed_now_playing import create_now_playing_embed
from utils.formatters import format_duration

from .track_select import TrackSelect


class MusicPlayerView(ui.View):
    def __init__(self, player, message=None, requester=None):
        super().__init__(timeout=None)

        self.player = player
        self.message = message
        self.requester = requester

        self.player.view = self  # ‚úÖ –¢–µ–ø–µ—Ä—å self.player —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        # 1. –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç –ø–µ—Ä–≤—ã–º
        self.add_item(TrackSelect(player, requester))

        # 2. –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤—Ä—É—á–Ω—É—é, –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
        self.add_item(self._make_button("music:shuffle", Emojis.NK_RANDOM, self.shuffle_button))
        self.add_item(self._make_button("music:previous", Emojis.NK_BACK, self.previous_button))
        self.add_item(self._make_button("music:pause", Emojis.NK_MUSICPLAY, self.pause_button))
        self.add_item(self._make_button("music:skip", Emojis.NK_NEXT, self.skip_button))
        self.add_item(self._make_button("music:loop", Emojis.NK_POVTOR, self.loop_button))
        self.add_item(self._make_button("music:seek", Emojis.NK_TIME, self.seek_button))
        self.add_item(self._make_button("music:volume", Emojis.NK_VOLUME, self.volume_button))
        self.add_item(self._make_button("music:stop", Emojis.NK_LEAVE, self.stop_button))
        self.add_item(self._make_button("music:lyrics", Emojis.NK_TEXT, self.lyrics_button))
        self.add_item(self._make_button("music:like", Emojis.NK_HEART, self.like_button))

    def _make_button(self, custom_id, emoji, callback, style=discord.ButtonStyle.secondary):
        button = ui.Button(emoji=emoji, style=style, custom_id=custom_id)
        button.callback = callback
        return button

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    async def refresh_select_menu(self):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å–µ–ª–µ–∫—Ç —Ç—Ä–µ–∫–æ–≤ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ"""
        # –£–¥–∞–ª–∏–º —Å—Ç–∞—Ä—ã–π TrackSelect
        for item in self.children:
            if isinstance(item, TrackSelect):
                self.remove_item(item)
                break

        # –î–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–π TrackSelect —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π
        self.add_item(TrackSelect(self.player, self.requester))

        # –û–±–Ω–æ–≤–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if self.message:
            try:
                await self.message.edit(view=self)
            except discord.HTTPException:
                pass  # –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–æ

    async def shuffle_button(self, interaction: discord.Interaction):
        if self.player.queue:
            self.player.queue.shuffle()
            await interaction.response.send_message(f"{Emojis.NK_RANDOM} –û—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–º–µ—à–∞–Ω–∞", ephemeral=True)
        else:
            await interaction.response.send_message("‚ùå –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞", ephemeral=True)

    async def previous_button(self, interaction: discord.Interaction):
        if hasattr(self.player, "play_previous"):
            success = await self.player.play_previous()
            if success:
                embed = create_now_playing_embed(self.player.current, self.player, interaction.user)
                await self.message.edit(embed=embed, view=self)
                await interaction.response.defer()
            else:
                await interaction.response.send_message("‚ùå –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω", ephemeral=True)
        else:
            await interaction.response.send_message("‚ö†Ô∏è –ü–ª–µ–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `play_previous()`", ephemeral=True)

    async def pause_button(self, interaction: discord.Interaction):
        if self.player.paused:
            await self.player.pause(False)
        else:
            await self.player.pause(True)

        embed = create_now_playing_embed(self.player.current, self.player, interaction.user)
        await self.message.edit(embed=embed, view=self)
        await interaction.response.defer()

    async def skip_button(self, interaction: discord.Interaction):
        await self.player.skip()
        embed = create_now_playing_embed(self.player.current, self.player, interaction.user)
        await self.message.edit(embed=embed, view=self)
        await interaction.response.defer()

    async def loop_button(self, interaction: discord.Interaction):
        self.player.loop = not getattr(self.player, "loop", False)
        await interaction.response.edit_message(view=self)

    async def seek_button(self, interaction: discord.Interaction):
        pos = format_duration(self.player.position)
        dur = format_duration(self.player.current.length)
        embed = discord.Embed(
            title="üìç –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–µ–π",
            description=f"**–¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è:** `{pos}`\n**–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞:** `{dur}`",
            color=discord.Color.blurple()
        )
        await interaction.response.send_message(embed=embed, ephemeral=True)

    async def volume_button(self, interaction: discord.Interaction):
        volume = getattr(self.player, "volume", 100)
        embed = discord.Embed(
            title=f"{Emojis.NK_VOLUME} –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å—é",
            description=f"**–ì—Ä–æ–º–∫–æ—Å—Ç—å:** {volume}%",
            color=discord.Color.blurple()
        )
        await interaction.response.send_message(embed=embed, ephemeral=True)

    async def stop_button(self, interaction: discord.Interaction):
        await self.player.disconnect()
        await interaction.response.edit_message(view=None)

    async def lyrics_button(self, interaction: discord.Interaction):
        await interaction.response.send_message("üìÑ –¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.", ephemeral=True)

    async def like_button(self, interaction: discord.Interaction):
        user = interaction.user.mention
        embed = discord.Embed(
            title="‚Äî„Éª–ü–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è",
            description=f"{user}, –≤ –∫–∞–∫–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–µ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–π —Ç—Ä–µ–∫?\n\n*–ù–∞–ø—Ä–∏–º–µ—Ä:* `–ª—é–±–∏–º—ã–µ —Ç—Ä–µ–∫–∏`",
            color=discord.Color.red()
        )
        await interaction.response.send_message(embed=embed, ephemeral=True)
